<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generating Your App...</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”„ Generating Your Flutter App</h1>
            <p>Please wait while our AI agents work their magic...</p>
        </header>

        <main>
            <div class="progress-card">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressPercent">0%</span>
                    <span id="currentAgent">Starting...</span>
                </div>

                <div class="agent-steps">
                    <div class="agent-step" id="step-prompt_analyzer">
                        <div class="step-icon">ğŸ”</div>
                        <div class="step-content">
                            <h4>Analyzing Prompt</h4>
                            <p>Understanding your requirements...</p>
                        </div>
                        <div class="step-status">â³</div>
                    </div>

                    <div class="agent-step" id="step-architecture_designer">
                        <div class="step-icon">ğŸ—ï¸</div>
                        <div class="step-content">
                            <h4>Designing Architecture</h4>
                            <p>Creating Flutter project structure...</p>
                        </div>
                        <div class="step-status">â³</div>
                    </div>

                    <div class="agent-step" id="step-code_generator">
                        <div class="step-icon">ğŸ’»</div>
                        <div class="step-content">
                            <h4>Generating Code</h4>
                            <p>Writing Flutter source files...</p>
                        </div>
                        <div class="step-status">â³</div>
                    </div>

                    <div class="agent-step" id="step-build_automator">
                        <div class="step-icon">ğŸ“±</div>
                        <div class="step-content">
                            <h4>Building APK</h4>
                            <p>Compiling and packaging app...</p>
                        </div>
                        <div class="step-status">â³</div>
                    </div>
                </div>

                <div id="errorDisplay" class="error-display" style="display: none;">
                    <h4>âš ï¸ Errors Encountered:</h4>
                    <ul id="errorList"></ul>
                </div>

                <div id="completedActions" style="display: none;">
                    <a href="/results/{{ session_id }}" class="btn-primary">
                        ğŸ“± Download Your APK
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        const sessionId = '{{ session_id }}';
        
        // Start generation process
        fetch(`/api/start-generation/${sessionId}`, {
            method: 'POST'
        });

        // Poll for progress updates
        function updateProgress() {
        fetch(`/api/progress/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                document.getElementById('progressFill').style.width = data.progress + '%';
                document.getElementById('progressPercent').textContent = data.progress + '%';
                
                // Update current agent
                const agentNames = {
                    'prompt_analyzer': 'Analyzing Prompt',
                    'architecture_designer': 'Designing Architecture', 
                    'code_generator': 'Generating Code',
                    'build_automator': 'Building APK',
                    'completed': 'Completed!'
                };
                
                document.getElementById('currentAgent').textContent = 
                    agentNames[data.current_agent] || data.current_agent;
                
                // Update step statuses
                updateStepStatuses(data.current_agent, data.progress);
                
                // Show errors if any
                if (data.errors && data.errors.length > 0) {
                    showErrors(data.errors);
                }
                
                // Show completion if ready - STOP POLLING HERE
                if (data.completed || data.apk_ready) {
                    document.getElementById('completedActions').style.display = 'block';
                    document.getElementById('status').textContent = 'Generation Complete!';
                    console.log('Generation completed - stopping progress updates');
                    return; // Stop polling
                }
                
                // Continue polling only if not completed
                if (!data.completed && data.build_status !== 'failed') {
                    setTimeout(updateProgress, 2000);
                }
            })
            .catch(error => {
                console.error('Progress update error:', error);
                // Still retry on error, but less frequently
                setTimeout(updateProgress, 5000);
            });
    }

        
        function updateStepStatuses(currentAgent, progress) {
            const steps = ['prompt_analyzer', 'architecture_designer', 'code_generator', 'build_automator'];
            const currentIndex = steps.indexOf(currentAgent);
            
            steps.forEach((step, index) => {
                const stepElement = document.getElementById(`step-${step}`);
                const statusElement = stepElement.querySelector('.step-status');
                
                if (index < currentIndex) {
                    stepElement.classList.add('completed');
                    statusElement.textContent = 'âœ…';
                } else if (index === currentIndex) {
                    stepElement.classList.add('active');
                    statusElement.textContent = 'ğŸ”„';
                } else {
                    stepElement.classList.remove('active', 'completed');
                    statusElement.textContent = 'â³';
                }
            });
        }
        
        function showErrors(errors) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorDisplay.style.display = 'block';
        }
        
        // Start progress updates
        updateProgress();
    </script>
</body>
</html>
